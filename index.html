<html>
  <head>
  <link rel="stylesheet" type="text/css" href="remotewidget.css">
  <link rel="stylesheet" type="text/css" href="jquery.jgrowl.css">
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/jquery-ui.min.js"></script>
  <script src="jquery.jsonp-1.0.5.min.js"></script>
  <script src="flot/jquery.flot.pack.js"></script>
  <script src="iso8601.js"></script>
  <script src="queue.js"></script>
  <script src="ssbe.js"></script>
  <script src="jquery.jgrowl.js"></script>
    <script>
      $.jsonp.setup({
        cache: true,
        callbackParameter: "_callback"
      });
      var metrics_cache = [];
      var graph_list = [];
      var data = [];
      var servicedesc = "http://core.deltaplex3.dev.api.local/service_descriptors";

      $(document).ready(function() {
        findservice("http://systemshepherd.com/services/kernel",function(srv) {
          findresource("AllClients",srv,function(res) {
            getresource(res.href,function(resource) {
              $.each(resource.items,function() {
                $('#clientselect').append("<option value="+this.href+">"+this.name+"<\/option>");
              });
            });
          });
        });

        $("#clientselect").change(function() {
          metrics_cache = [];
          $('#hostselect').empty();
          $('#suggest').empty();
          $('#metricfinder').val("");
          client_href = $('#clientselect').val();
          getresource(client_href,function(client) {
            getresource(client.hosts_href,function(hosts) {
              var content = '<option value="">Select a Host<\/option>';
              $.each(hosts.items,function() { 
                content += "<option value="+this.href+">"+this.name+"<\/option>";
              });
              $('#hostselect').html(content); 
              $('#hostselect').fadeIn();
            });
          });
        });

        $("#hostselect").change(function() {
          metrics_cache = [];
          $('#suggest').empty();
          $('#metricfinder').val("");
          host_href = $('#hostselect').val();
          getresource(host_href,function(host) {
            getresource(host.metrics_href, function(metrics) {
              metrics_cache = metrics;
            });
          });
          $('#metricfinder').fadeIn();
        });

        $('#metricfinder').keyup(function() {
          search = $('#metricfinder').val();
            if (search.length > 0)
            {
              content ="";
              found = $.grep(metrics_cache.items,function(metric, i) {
                return (metric.metric_type.path.toLowerCase().match(search.toLowerCase()));
              });
              $.each(found,function () {
                content += "<li><a href=\""+this.observations_href+"\">Add "+this.metric_type.path+"<\/a><\/li>";
              });
              $('#suggest').html(content);
              $('#suggest').fadeIn();
            } else
            {
              $('#suggest').empty();
            }
        });
        $('#suggest').click(function(e) {
          var content = "";
          var clicked = $(e.target);
          graph_list.push(clicked.attr("href"));
          $.jGrowl(clicked.attr("href"));

          $("#graphbutton").fadeIn();
          $("#graph").fadeOut();
          $("#graphitems").html(content);
          return false;
        });
        $('#graphbutton').click(function() {
          graphlist('#graph',graph_list);
        });

        $('form').submit(function () {
          return false;
        });
      });
    </script>
  </head>
  <body>
    <div id="content">
      <form name="selector">
        <select id="clientselect">
          <option value="">Select a Client</option>
        </select>
        <select id="hostselect" style="display:none;">
          <option value="">Select a Host</option>
        </select>
        <input type="text" name="metric_search" id="metricfinder" style="display:none;" />
        <button id="graphbutton" style="display:none;">Graph</button>
      </form>
    </div>
    <div id="searchresults">
      <ul id="suggest">
      </ul>
    </div>
    <span id="graphlist"><ul id="graphitems"></ul></span>
      <div id="graph"></div>
  </body>
</html>
